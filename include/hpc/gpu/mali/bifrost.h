/*
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#ifndef HPC_GPU_MALI_BIFROST_H_
#define HPC_GPU_MALI_BIFROST_H_

#include <stdint.h>

#include "hpc/gpu/base_utilities.h"

#ifdef __cplusplus
extern "C" {
#endif  // __cplusplus

// Forward declaration of the counter enum.
typedef enum hpc_gpu_mali_bifrost_counter_e hpc_gpu_mali_bifrost_counter_t;

/// The context for sampling Mali GPU counters.
typedef struct hpc_gpu_mali_context_t hpc_gpu_mali_context_t;

/// Creates a context for sampling counters available to all known Mali Bifrost
/// GPUs.
///
/// Creating the context means talking with the Mali GPU kernel driver and
/// allocating resources for sampling the given counters.
///
/// @param[in]  num_counters The number of counters to sample later.
/// @param[in]  counters     The pointer to the list of counters to sample
///                          later.
/// @param[in]  allocator    The allocator used to allocate host memory for
///                          sampling counters later.
/// @param[out] out_context  The pointer to the object receiving the resultant
///                          context.
int hpc_gpu_mali_bifrost_create_context(
    uint32_t num_counters, hpc_gpu_mali_bifrost_counter_t *counters,
    const hpc_gpu_host_allocation_callbacks_t *allocator,
    hpc_gpu_mali_context_t **out_context);

/// Destroys the context for common Mali Bifrost GPU counters.
///
/// @param[in] context   The counter sampling context.
/// @param[in] allocator The allocator used to free allocated host memory.
int hpc_gpu_mali_bifrost_destroy_context(
    hpc_gpu_mali_context_t *context,
    const hpc_gpu_host_allocation_callbacks_t *allocator);

/// Starts sampling the common Mali Bifrost GPU counters specified when creating
/// the context.
///
/// This zeros the registered counters in preparation for continously sampling.
///
/// @param[in] context The counter sampling context.
int hpc_gpu_mali_bifrost_start_counters(const hpc_gpu_mali_context_t *context);

/// Stops sampling the common Mali Bifrost GPU counters specified when creating
/// the context.
///
/// @param[in] context The counter sampling context.
int hpc_gpu_mali_bifrost_stop_counters(const hpc_gpu_mali_context_t *context);

/// Samples the common Mali Bifrost GPU counters specified when creating
/// the context.
///
/// @param[in]  context The counter sampling context.
/// @param[out] values  The pointer to the memory for receiving newly sampled
///                     values. Its element count should be greater than or
///                     equal to the number of counters specified when
///                     creating the `context`.
int hpc_gpu_mali_bifrost_query_counters(const hpc_gpu_mali_context_t *context,
                                        uint64_t *values);

//===-------------- BEGIN AUTOGENERATED REGION; DO NOT EDIT! --------------===//

/// Common Mali Bifrost GPU counters.
typedef enum hpc_gpu_mali_bifrost_counter_e {
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_MESSAGES_SENT = 4u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_MESSAGES_RECEIVED = 5u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_GPU_ACTIVE = 6u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_IRQ_ACTIVE = 7u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_JOBS = 8u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_TASKS = 9u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_ACTIVE = 10u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_WAIT_READ = 12u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_WAIT_ISSUE = 13u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_WAIT_DEPEND = 14u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS0_WAIT_FINISH = 15u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_JOBS = 16u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_TASKS = 17u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_ACTIVE = 18u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_WAIT_READ = 20u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_WAIT_ISSUE = 21u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_WAIT_DEPEND = 22u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS1_WAIT_FINISH = 23u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_JOBS = 24u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_TASKS = 25u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_ACTIVE = 26u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_WAIT_READ = 28u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_WAIT_ISSUE = 29u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_WAIT_DEPEND = 30u,
  HPC_GPU_MALI_BIFROST_JOB_MANAGER_JS2_WAIT_FINISH = 31u,
  HPC_GPU_MALI_BIFROST_TILER_TILER_ACTIVE = 260u,
  HPC_GPU_MALI_BIFROST_TILER_JOBS_PROCESSED = 261u,
  HPC_GPU_MALI_BIFROST_TILER_TRIANGLES = 262u,
  HPC_GPU_MALI_BIFROST_TILER_LINES = 263u,
  HPC_GPU_MALI_BIFROST_TILER_POINTS = 264u,
  HPC_GPU_MALI_BIFROST_TILER_FRONT_FACING = 265u,
  HPC_GPU_MALI_BIFROST_TILER_BACK_FACING = 266u,
  HPC_GPU_MALI_BIFROST_TILER_PRIM_VISIBLE = 267u,
  HPC_GPU_MALI_BIFROST_TILER_PRIM_CULLED = 268u,
  HPC_GPU_MALI_BIFROST_TILER_PRIM_CLIPPED = 269u,
  HPC_GPU_MALI_BIFROST_TILER_PRIM_SAT_CULLED = 270u,
  HPC_GPU_MALI_BIFROST_TILER_BUS_READ = 273u,
  HPC_GPU_MALI_BIFROST_TILER_BUS_WRITE = 275u,
  HPC_GPU_MALI_BIFROST_TILER_LOADING_DESC = 276u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_POS_SHAD_REQ = 277u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_POS_SHAD_WAIT = 278u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_POS_SHAD_STALL = 279u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_POS_FIFO_FULL = 280u,
  HPC_GPU_MALI_BIFROST_TILER_PREFETCH_STALL = 281u,
  HPC_GPU_MALI_BIFROST_TILER_VCACHE_HIT = 282u,
  HPC_GPU_MALI_BIFROST_TILER_VCACHE_MISS = 283u,
  HPC_GPU_MALI_BIFROST_TILER_VCACHE_LINE_WAIT = 284u,
  HPC_GPU_MALI_BIFROST_TILER_VFETCH_POS_READ_WAIT = 285u,
  HPC_GPU_MALI_BIFROST_TILER_VFETCH_VERTEX_WAIT = 286u,
  HPC_GPU_MALI_BIFROST_TILER_VFETCH_STALL = 287u,
  HPC_GPU_MALI_BIFROST_TILER_PRIMASSY_STALL = 288u,
  HPC_GPU_MALI_BIFROST_TILER_BBOX_GEN_STALL = 289u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_VBU_HIT = 290u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_VBU_MISS = 291u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_VBU_LINE_DEALLOCATE = 292u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_VAR_SHAD_REQ = 293u,
  HPC_GPU_MALI_BIFROST_TILER_IDVS_VAR_SHAD_STALL = 294u,
  HPC_GPU_MALI_BIFROST_TILER_BINNER_STALL = 295u,
  HPC_GPU_MALI_BIFROST_TILER_ITER_STALL = 296u,
  HPC_GPU_MALI_BIFROST_TILER_COMPRESS_MISS = 297u,
  HPC_GPU_MALI_BIFROST_TILER_COMPRESS_STALL = 298u,
  HPC_GPU_MALI_BIFROST_TILER_PCACHE_HIT = 299u,
  HPC_GPU_MALI_BIFROST_TILER_PCACHE_MISS = 300u,
  HPC_GPU_MALI_BIFROST_TILER_PCACHE_MISS_STALL = 301u,
  HPC_GPU_MALI_BIFROST_TILER_PCACHE_EVICT_STALL = 302u,
  HPC_GPU_MALI_BIFROST_TILER_PMGR_PTR_WR_STALL = 303u,
  HPC_GPU_MALI_BIFROST_TILER_PMGR_PTR_RD_STALL = 304u,
  HPC_GPU_MALI_BIFROST_TILER_PMGR_CMD_WR_STALL = 305u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_ACTIVE = 306u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_HIT = 307u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_MISS = 308u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_NO_FREE_LINE_STALL = 309u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_NO_AXI_ID_STALL = 310u,
  HPC_GPU_MALI_BIFROST_TILER_WRBUF_AXI_STALL = 311u,
  HPC_GPU_MALI_BIFROST_TILER_UTLB_TRANS = 315u,
  HPC_GPU_MALI_BIFROST_TILER_UTLB_TRANS_HIT = 316u,
  HPC_GPU_MALI_BIFROST_TILER_UTLB_TRANS_STALL = 317u,
  HPC_GPU_MALI_BIFROST_TILER_UTLB_TRANS_MISS_DELAY = 318u,
  HPC_GPU_MALI_BIFROST_TILER_UTLB_MMU_REQ = 319u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_ACTIVE = 516u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_PRIMITIVES = 517u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_PRIM_RAST = 518u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_FPK_ACTIVE = 519u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_STARVING = 520u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_WARPS = 521u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_PARTIAL_WARPS = 522u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_QUADS_RAST = 523u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_QUADS_EZS_TEST = 524u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_QUADS_EZS_UPDATE = 525u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_QUADS_EZS_KILL = 526u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_LZS_TEST = 527u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_LZS_KILL = 528u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_PTILES = 530u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_FRAG_TRANS_ELIM = 531u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_QUAD_FPK_KILLER = 532u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_COMPUTE_ACTIVE = 534u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_COMPUTE_TASKS = 535u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_COMPUTE_WARPS = 536u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_COMPUTE_STARVING = 537u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_EXEC_CORE_ACTIVE = 538u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_EXEC_ACTIVE = 539u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_EXEC_INSTR_COUNT = 540u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_EXEC_INSTR_DIVERGED = 541u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_EXEC_INSTR_STARVING = 542u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ARITH_INSTR_SINGLE_FMA = 543u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ARITH_INSTR_DOUBLE = 544u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ARITH_INSTR_MSG = 545u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ARITH_INSTR_MSG_ONLY = 546u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_LS_MEM_READ_FULL = 556u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_LS_MEM_READ_SHORT = 557u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_LS_MEM_WRITE_FULL = 558u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_LS_MEM_WRITE_SHORT = 559u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_LS_MEM_ATOMIC = 560u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_VARY_INSTR = 561u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_VARY_SLOT_32 = 562u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_VARY_SLOT_16 = 563u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ATTR_INSTR = 564u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_ARITH_INSTR_FP_MUL = 565u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_FTC = 566u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_FTC_EXT = 567u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_LSC = 568u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_LSC_EXT = 569u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_TEX = 570u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_TEX_EXT = 571u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_RD_OTHER = 572u,
  HPC_GPU_MALI_BIFROST_SHADER_CORE_BEATS_WR_TIB = 574u,
  HPC_GPU_MALI_BIFROST_MEMORY_MMU_REQUESTS = 772u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_RD_MSG_IN = 784u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_RD_MSG_IN_STALL = 785u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_WR_MSG_IN = 786u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_WR_MSG_IN_STALL = 787u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_SNP_MSG_IN = 788u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_SNP_MSG_IN_STALL = 789u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_RD_MSG_OUT = 790u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_RD_MSG_OUT_STALL = 791u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_WR_MSG_OUT = 792u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_ANY_LOOKUP = 793u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_READ_LOOKUP = 794u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_WRITE_LOOKUP = 795u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP_LOOKUP = 796u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_READ = 797u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_READ_NOSNP = 798u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_READ_UNIQUE = 799u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_READ_BEATS = 800u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AR_STALL = 801u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AR_CNT_Q1 = 802u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AR_CNT_Q2 = 803u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AR_CNT_Q3 = 804u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_RRESP_0_127 = 805u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_RRESP_128_191 = 806u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_RRESP_192_255 = 807u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_RRESP_256_319 = 808u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_RRESP_320_383 = 809u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE = 810u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE_NOSNP_FULL = 811u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE_NOSNP_PTL = 812u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE_SNP_FULL = 813u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE_SNP_PTL = 814u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_WRITE_BEATS = 815u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_W_STALL = 816u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AW_CNT_Q1 = 817u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AW_CNT_Q2 = 818u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_AW_CNT_Q3 = 819u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP = 820u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP_STALL = 821u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP_RESP_CLEAN = 822u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP_RESP_DATA = 823u,
  HPC_GPU_MALI_BIFROST_MEMORY_L2_EXT_SNOOP_INTERNAL = 824u
} hpc_gpu_mali_bifrost_counter_t;

//===--------------- END AUTOGENERATED REGION; DO NOT EDIT! ---------------===//

#ifdef __cplusplus
}  // extern "C"
#endif  // __cplusplus

#endif  // HPC_GPU_MALI_BIFROST_H_
